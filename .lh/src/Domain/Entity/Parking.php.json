{
    "sourceFile": "src/Domain/Entity/Parking.php",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 10,
            "patches": [
                {
                    "date": 1766408009798,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766408176529,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -15,9 +15,9 @@\n use App\\Domain\\ValueObject\\AbonnementId;\r\n use App\\Domain\\ValueObject\\StationnementId;\r\n \r\n /**\r\n- * Aggregate root Parking : disponibilité, spots, règles d’accès.\r\n+ * Aggregate root Parking\r\n  */\r\n final class Parking\r\n {\r\n     private ParkingId $id;\r\n@@ -27,9 +27,9 @@\n     private int $totalCapacity;\r\n     private PricingPlan $pricingPlan;\r\n     private GeoLocation $location;\r\n     private OpeningSchedule $openingSchedule;\r\n-    private UserId $UserId; // (Owner)\r\n+    private UserId $userId;\r\n     private DateTimeImmutable $createdAt;\r\n     private DateTimeImmutable $updatedAt;\r\n \r\n     /** @var array<string, ParkingSpot> */\r\n@@ -51,9 +51,9 @@\n         int $totalCapacity,\r\n         PricingPlan $pricingPlan,\r\n         GeoLocation $location,\r\n         OpeningSchedule $openingSchedule,\r\n-        UserId $UserId,\r\n+        UserId $userId,\r\n         ?string $description = null,\r\n         ?DateTimeImmutable $createdAt = null,\r\n         ?DateTimeImmutable $updatedAt = null\r\n     ) {\r\n@@ -63,51 +63,39 @@\n \r\n         $this->id = $id;\r\n         $this->name = trim($name);\r\n         $this->address = trim($address);\r\n-        $this->description = $description !== null ? trim($description) : null;\r\n+        $this->description = $description ? trim($description) : null;\r\n         $this->totalCapacity = $totalCapacity;\r\n         $this->pricingPlan = $pricingPlan;\r\n         $this->location = $location;\r\n         $this->openingSchedule = $openingSchedule;\r\n-        $this->UserId = $UserId;\r\n+        $this->userId = $userId;\r\n         $this->createdAt = $createdAt ?? new DateTimeImmutable();\r\n         $this->updatedAt = $updatedAt ?? $this->createdAt;\r\n     }\r\n \r\n+    /* ================= GETTERS ================= */\r\n+\r\n     public function getId(): ParkingId { return $this->id; }\r\n     public function getName(): string { return $this->name; }\r\n     public function getAddress(): string { return $this->address; }\r\n     public function getDescription(): ?string { return $this->description; }\r\n     public function getTotalCapacity(): int { return $this->totalCapacity; }\r\n     public function getPricingPlan(): PricingPlan { return $this->pricingPlan; }\r\n     public function getLocation(): GeoLocation { return $this->location; }\r\n     public function getOpeningSchedule(): OpeningSchedule { return $this->openingSchedule; }\r\n-    public function getUserId(): UserId { return $this->UserId; }\r\n+    public function getUserId(): UserId { return $this->userId; }\r\n     public function getCreatedAt(): DateTimeImmutable { return $this->createdAt; }\r\n     public function getUpdatedAt(): DateTimeImmutable { return $this->updatedAt; }\r\n \r\n-    /** Change le plan tarifaire. */\r\n-    public function changePricingPlan(PricingPlan $newPlan): void\r\n-    {\r\n-        $this->pricingPlan = $newPlan;\r\n-        $this->touch();\r\n-    }\r\n+    /* ================= SPOTS ================= */\r\n \r\n-    /** Change les horaires d’ouverture. */\r\n-    public function changeOpeningSchedule(OpeningSchedule $schedule): void\r\n-    {\r\n-        $this->openingSchedule = $schedule;\r\n-        $this->touch();\r\n-    }\r\n-\r\n-    /** ✅ AJOUT: parking complet si nb de spots == capacité */\r\n     public function isFull(): bool\r\n     {\r\n-        return \\count($this->parkingSpots) >= $this->totalCapacity;\r\n+        return count($this->parkingSpots) >= $this->totalCapacity;\r\n     }\r\n \r\n-    /** ✅ AJOUT: ajoute un spot en vérifiant doublon + capacité */\r\n     public function addSpot(ParkingSpot $spot): void\r\n     {\r\n         $spotId = $spot->getId()->getValue();\r\n \r\n@@ -122,102 +110,105 @@\n         $this->parkingSpots[$spotId] = $spot;\r\n         $this->touch();\r\n     }\r\n \r\n-    /** ✅ AJOUT: places libres physiques restantes */\r\n     public function getPhysicalFreeSpotsCount(): int\r\n     {\r\n-        return $this->totalCapacity - \\count($this->parkingSpots);\r\n+        return $this->totalCapacity - count($this->parkingSpots);\r\n     }\r\n \r\n-    /** Marque une réservation liée à ce parking. */\r\n+    /* ================= ATTACH ================= */\r\n+\r\n     public function attachReservation(ReservationId $reservationId): void\r\n     {\r\n         $this->reservationIds[$reservationId->getValue()] = $reservationId;\r\n     }\r\n \r\n-    /** Marque un abonnement lié à ce parking. */\r\n     public function attachAbonnement(AbonnementId $abonnementId): void\r\n     {\r\n         $this->abonnementIds[$abonnementId->getValue()] = $abonnementId;\r\n     }\r\n \r\n-    /** Marque un stationnement actif lié à ce parking. */\r\n     public function attachStationnement(StationnementId $stationnementId): void\r\n     {\r\n         $this->stationnementIds[$stationnementId->getValue()] = $stationnementId;\r\n     }\r\n \r\n-    public function computeAvailability(int $activeReservations, int $activeAbonnements, int $activeStationnements): int\r\n-    {\r\n-        $used = $activeReservations + $activeAbonnements + $activeStationnements;\r\n-        return max(0, $this->totalCapacity - $used);\r\n+    public function computeAvailability(\r\n+        int $activeReservations,\r\n+        int $activeAbonnements,\r\n+        int $activeStationnements\r\n+    ): int {\r\n+        return max(0, $this->totalCapacity - (\r\n+            $activeReservations + $activeAbonnements + $activeStationnements\r\n+        ));\r\n     }\r\n \r\n-    /**\r\n-     * Nombre de places libres à un instant t.\r\n-     *\r\n-     * @param iterable<int, object> $reservations   objets avec isActiveAt(DateTimeImmutable $at): bool\r\n-     * @param iterable<int, object> $abonnements    objets avec covers(DateTimeImmutable $at): bool\r\n-     * @param iterable<int, object> $stationnements objets avec isActiveAt(DateTimeImmutable $at): bool\r\n-     */\r\n+    /* ================= BUSINESS ================= */\r\n+\r\n     public function freeSpotsAt(\r\n         DateTimeImmutable $at,\r\n         iterable $reservations,\r\n         iterable $abonnements,\r\n         iterable $stationnements\r\n     ): int {\r\n         $used = 0;\r\n \r\n-        foreach ($reservations as $reservation) {\r\n-            if (\\method_exists($reservation, 'isActiveAt') && $reservation->isActiveAt($at)) {\r\n+        foreach ($reservations as $r) {\r\n+            if (method_exists($r, 'isActiveAt') && $r->isActiveAt($at)) {\r\n                 $used++;\r\n             }\r\n         }\r\n \r\n-        foreach ($abonnements as $abonnement) {\r\n-            if (\\method_exists($abonnement, 'covers') && $abonnement->covers($at)) {\r\n+        foreach ($abonnements as $a) {\r\n+            if (method_exists($a, 'covers') && $a->covers($at)) {\r\n                 $used++;\r\n             }\r\n         }\r\n \r\n-        foreach ($stationnements as $stationnement) {\r\n-            if (\\method_exists($stationnement, 'isActiveAt') && $stationnement->isActiveAt($at)) {\r\n+        foreach ($stationnements as $s) {\r\n+            if (method_exists($s, 'isActiveAt') && $s->isActiveAt($at)) {\r\n                 $used++;\r\n             }\r\n         }\r\n \r\n         return max(0, $this->totalCapacity - $used);\r\n     }\r\n \r\n-    /** Vérifie si le parking est ouvert à un instant donné. */\r\n     public function isOpenAt(DateTimeImmutable $at): bool\r\n     {\r\n         return $this->openingSchedule->isOpenAt($at);\r\n     }\r\n \r\n-    /** Calcul du prix pour une durée (en minutes) en utilisant le plan tarifaire. */\r\n     public function computePriceForDurationMinutes(int $minutes): int\r\n     {\r\n         return $this->pricingPlan->computePriceCents($minutes);\r\n     }\r\n \r\n-    /** Met à jour la capacité totale. */\r\n+    public function changePricingPlan(PricingPlan $newPlan): void\r\n+    {\r\n+        $this->pricingPlan = $newPlan;\r\n+        $this->touch();\r\n+    }\r\n+\r\n+    public function changeOpeningSchedule(OpeningSchedule $schedule): void\r\n+    {\r\n+        $this->openingSchedule = $schedule;\r\n+        $this->touch();\r\n+    }\r\n+\r\n     public function updateCapacity(int $newCapacity): void\r\n     {\r\n         if ($newCapacity <= 0) {\r\n             throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n         }\r\n \r\n-        if ($newCapacity === $this->totalCapacity) {\r\n-            return;\r\n+        if ($newCapacity < count($this->parkingSpots)) {\r\n+            throw new \\InvalidArgumentException(\r\n+                'La capacite ne peut pas etre inferieure au nombre de places existantes.'\r\n+            );\r\n         }\r\n \r\n-        // ⚠️ règle simple: on empêche de réduire sous le nb de spots déjà existants\r\n-        if ($newCapacity < \\count($this->parkingSpots)) {\r\n-            throw new \\InvalidArgumentException('La nouvelle capacite ne peut pas etre inferieure au nombre de places existantes.');\r\n-        }\r\n-\r\n         $this->totalCapacity = $newCapacity;\r\n         $this->touch();\r\n     }\r\n \r\n"
                },
                {
                    "date": 1766408233294,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,8 +5,9 @@\n \r\n use DateTimeImmutable;\r\n use App\\Domain\\Exception\\ParkingFullException;\r\n use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n+use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n use App\\Domain\\ValueObject\\GeoLocation;\r\n use App\\Domain\\ValueObject\\OpeningSchedule;\r\n use App\\Domain\\ValueObject\\ParkingId;\r\n use App\\Domain\\ValueObject\\PricingPlan;\r\n"
                },
                {
                    "date": 1766408410768,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,9 +5,8 @@\n \r\n use DateTimeImmutable;\r\n use App\\Domain\\Exception\\ParkingFullException;\r\n use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n-use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n use App\\Domain\\ValueObject\\GeoLocation;\r\n use App\\Domain\\ValueObject\\OpeningSchedule;\r\n use App\\Domain\\ValueObject\\ParkingId;\r\n use App\\Domain\\ValueObject\\PricingPlan;\r\n@@ -15,17 +14,13 @@\n use App\\Domain\\ValueObject\\ReservationId;\r\n use App\\Domain\\ValueObject\\AbonnementId;\r\n use App\\Domain\\ValueObject\\StationnementId;\r\n \r\n-/**\r\n- * Aggregate root Parking\r\n- */\r\n final class Parking\r\n {\r\n     private ParkingId $id;\r\n     private string $name;\r\n     private string $address;\r\n-    private ?string $description;\r\n     private int $totalCapacity;\r\n     private PricingPlan $pricingPlan;\r\n     private GeoLocation $location;\r\n     private OpeningSchedule $openingSchedule;\r\n@@ -52,87 +47,82 @@\n         int $totalCapacity,\r\n         PricingPlan $pricingPlan,\r\n         GeoLocation $location,\r\n         OpeningSchedule $openingSchedule,\r\n-        UserId $userId,\r\n-        ?string $description = null,\r\n-        ?DateTimeImmutable $createdAt = null,\r\n-        ?DateTimeImmutable $updatedAt = null\r\n+        UserId $userId\r\n     ) {\r\n         if ($totalCapacity <= 0) {\r\n-            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n+            throw new \\InvalidArgumentException('Capacity must be greater than zero.');\r\n         }\r\n \r\n         $this->id = $id;\r\n-        $this->name = trim($name);\r\n-        $this->address = trim($address);\r\n-        $this->description = $description ? trim($description) : null;\r\n+        $this->name = $name;\r\n+        $this->address = $address;\r\n         $this->totalCapacity = $totalCapacity;\r\n         $this->pricingPlan = $pricingPlan;\r\n         $this->location = $location;\r\n         $this->openingSchedule = $openingSchedule;\r\n         $this->userId = $userId;\r\n-        $this->createdAt = $createdAt ?? new DateTimeImmutable();\r\n-        $this->updatedAt = $updatedAt ?? $this->createdAt;\r\n+        $this->createdAt = new DateTimeImmutable();\r\n+        $this->updatedAt = $this->createdAt;\r\n     }\r\n \r\n-    /* ================= GETTERS ================= */\r\n+    /* ===== GETTERS ===== */\r\n \r\n     public function getId(): ParkingId { return $this->id; }\r\n     public function getName(): string { return $this->name; }\r\n     public function getAddress(): string { return $this->address; }\r\n-    public function getDescription(): ?string { return $this->description; }\r\n     public function getTotalCapacity(): int { return $this->totalCapacity; }\r\n     public function getPricingPlan(): PricingPlan { return $this->pricingPlan; }\r\n     public function getLocation(): GeoLocation { return $this->location; }\r\n     public function getOpeningSchedule(): OpeningSchedule { return $this->openingSchedule; }\r\n     public function getUserId(): UserId { return $this->userId; }\r\n     public function getCreatedAt(): DateTimeImmutable { return $this->createdAt; }\r\n     public function getUpdatedAt(): DateTimeImmutable { return $this->updatedAt; }\r\n \r\n-    /* ================= SPOTS ================= */\r\n+    /* ===== SPOTS ===== */\r\n \r\n     public function isFull(): bool\r\n     {\r\n         return count($this->parkingSpots) >= $this->totalCapacity;\r\n     }\r\n \r\n     public function addSpot(ParkingSpot $spot): void\r\n     {\r\n-        $spotId = $spot->getId()->getValue();\r\n+        $id = $spot->getId()->getValue();\r\n \r\n-        if (isset($this->parkingSpots[$spotId])) {\r\n+        if (isset($this->parkingSpots[$id])) {\r\n             throw new SpotAlreadyExistsException();\r\n         }\r\n \r\n         if ($this->isFull()) {\r\n             throw new ParkingFullException();\r\n         }\r\n \r\n-        $this->parkingSpots[$spotId] = $spot;\r\n+        $this->parkingSpots[$id] = $spot;\r\n         $this->touch();\r\n     }\r\n \r\n     public function getPhysicalFreeSpotsCount(): int\r\n     {\r\n         return $this->totalCapacity - count($this->parkingSpots);\r\n     }\r\n \r\n-    /* ================= ATTACH ================= */\r\n+    /* ===== ATTACH ===== */\r\n \r\n-    public function attachReservation(ReservationId $reservationId): void\r\n+    public function attachReservation(ReservationId $id): void\r\n     {\r\n-        $this->reservationIds[$reservationId->getValue()] = $reservationId;\r\n+        $this->reservationIds[$id->getValue()] = $id;\r\n     }\r\n \r\n-    public function attachAbonnement(AbonnementId $abonnementId): void\r\n+    public function attachAbonnement(AbonnementId $id): void\r\n     {\r\n-        $this->abonnementIds[$abonnementId->getValue()] = $abonnementId;\r\n+        $this->abonnementIds[$id->getValue()] = $id;\r\n     }\r\n \r\n-    public function attachStationnement(StationnementId $stationnementId): void\r\n+    public function attachStationnement(StationnementId $id): void\r\n     {\r\n-        $this->stationnementIds[$stationnementId->getValue()] = $stationnementId;\r\n+        $this->stationnementIds[$id->getValue()] = $id;\r\n     }\r\n \r\n     public function computeAvailability(\r\n         int $activeReservations,\r\n@@ -143,9 +133,9 @@\n             $activeReservations + $activeAbonnements + $activeStationnements\r\n         ));\r\n     }\r\n \r\n-    /* ================= BUSINESS ================= */\r\n+    /* ===== BUSINESS ===== */\r\n \r\n     public function freeSpotsAt(\r\n         DateTimeImmutable $at,\r\n         iterable $reservations,\r\n@@ -184,36 +174,8 @@\n     {\r\n         return $this->pricingPlan->computePriceCents($minutes);\r\n     }\r\n \r\n-    public function changePricingPlan(PricingPlan $newPlan): void\r\n-    {\r\n-        $this->pricingPlan = $newPlan;\r\n-        $this->touch();\r\n-    }\r\n-\r\n-    public function changeOpeningSchedule(OpeningSchedule $schedule): void\r\n-    {\r\n-        $this->openingSchedule = $schedule;\r\n-        $this->touch();\r\n-    }\r\n-\r\n-    public function updateCapacity(int $newCapacity): void\r\n-    {\r\n-        if ($newCapacity <= 0) {\r\n-            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n-        }\r\n-\r\n-        if ($newCapacity < count($this->parkingSpots)) {\r\n-            throw new \\InvalidArgumentException(\r\n-                'La capacite ne peut pas etre inferieure au nombre de places existantes.'\r\n-            );\r\n-        }\r\n-\r\n-        $this->totalCapacity = $newCapacity;\r\n-        $this->touch();\r\n-    }\r\n-\r\n     private function touch(): void\r\n     {\r\n         $this->updatedAt = new DateTimeImmutable();\r\n     }\r\n"
                },
                {
                    "date": 1766408604929,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -50,9 +50,9 @@\n         OpeningSchedule $openingSchedule,\r\n         UserId $userId\r\n     ) {\r\n         if ($totalCapacity <= 0) {\r\n-            throw new \\InvalidArgumentException('Capacity must be greater than zero.');\r\n+            throw new \\InvalidArgumentException('Capacity must be greater than zero');\r\n         }\r\n \r\n         $this->id = $id;\r\n         $this->name = $name;\r\n@@ -65,9 +65,9 @@\n         $this->createdAt = new DateTimeImmutable();\r\n         $this->updatedAt = $this->createdAt;\r\n     }\r\n \r\n-    /* ===== GETTERS ===== */\r\n+    /* ================= GETTERS ================= */\r\n \r\n     public function getId(): ParkingId { return $this->id; }\r\n     public function getName(): string { return $this->name; }\r\n     public function getAddress(): string { return $this->address; }\r\n@@ -78,65 +78,38 @@\n     public function getUserId(): UserId { return $this->userId; }\r\n     public function getCreatedAt(): DateTimeImmutable { return $this->createdAt; }\r\n     public function getUpdatedAt(): DateTimeImmutable { return $this->updatedAt; }\r\n \r\n-    /* ===== SPOTS ===== */\r\n+    /* ================= SPOTS ================= */\r\n \r\n     public function isFull(): bool\r\n     {\r\n         return count($this->parkingSpots) >= $this->totalCapacity;\r\n     }\r\n \r\n     public function addSpot(ParkingSpot $spot): void\r\n     {\r\n-        $id = $spot->getId()->getValue();\r\n+        $spotId = $spot->getId()->getValue();\r\n \r\n-        if (isset($this->parkingSpots[$id])) {\r\n+        if (isset($this->parkingSpots[$spotId])) {\r\n             throw new SpotAlreadyExistsException();\r\n         }\r\n \r\n         if ($this->isFull()) {\r\n             throw new ParkingFullException();\r\n         }\r\n \r\n-        $this->parkingSpots[$id] = $spot;\r\n+        $this->parkingSpots[$spotId] = $spot;\r\n         $this->touch();\r\n     }\r\n \r\n     public function getPhysicalFreeSpotsCount(): int\r\n     {\r\n         return $this->totalCapacity - count($this->parkingSpots);\r\n     }\r\n \r\n-    /* ===== ATTACH ===== */\r\n+    /* ================= BUSINESS ================= */\r\n \r\n-    public function attachReservation(ReservationId $id): void\r\n-    {\r\n-        $this->reservationIds[$id->getValue()] = $id;\r\n-    }\r\n-\r\n-    public function attachAbonnement(AbonnementId $id): void\r\n-    {\r\n-        $this->abonnementIds[$id->getValue()] = $id;\r\n-    }\r\n-\r\n-    public function attachStationnement(StationnementId $id): void\r\n-    {\r\n-        $this->stationnementIds[$id->getValue()] = $id;\r\n-    }\r\n-\r\n-    public function computeAvailability(\r\n-        int $activeReservations,\r\n-        int $activeAbonnements,\r\n-        int $activeStationnements\r\n-    ): int {\r\n-        return max(0, $this->totalCapacity - (\r\n-            $activeReservations + $activeAbonnements + $activeStationnements\r\n-        ));\r\n-    }\r\n-\r\n-    /* ===== BUSINESS ===== */\r\n-\r\n     public function freeSpotsAt(\r\n         DateTimeImmutable $at,\r\n         iterable $reservations,\r\n         iterable $abonnements,\r\n@@ -174,8 +147,28 @@\n     {\r\n         return $this->pricingPlan->computePriceCents($minutes);\r\n     }\r\n \r\n+    public function attachReservation(ReservationId $id): void\r\n+    {\r\n+        $this->reservationIds[$id->getValue()] = $id;\r\n+    }\r\n+\r\n+    public function attachAbonnement(AbonnementId $id): void\r\n+    {\r\n+        $this->abonnementIds[$id->getValue()] = $id;\r\n+    }\r\n+\r\n+    public function attachStationnement(StationnementId $id): void\r\n+    {\r\n+        $this->stationnementIds[$id->getValue()] = $id;\r\n+    }\r\n+\r\n+    public function computeAvailability(int $r, int $a, int $s): int\r\n+    {\r\n+        return max(0, $this->totalCapacity - ($r + $a + $s));\r\n+    }\r\n+\r\n     private function touch(): void\r\n     {\r\n         $this->updatedAt = new DateTimeImmutable();\r\n     }\r\n"
                },
                {
                    "date": 1766408913819,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -19,13 +19,14 @@\n {\r\n     private ParkingId $id;\r\n     private string $name;\r\n     private string $address;\r\n+    private ?string $description;\r\n     private int $totalCapacity;\r\n     private PricingPlan $pricingPlan;\r\n     private GeoLocation $location;\r\n     private OpeningSchedule $openingSchedule;\r\n-    private UserId $userId;\r\n+    private UserId $UserId; // (Owner)\r\n     private DateTimeImmutable $createdAt;\r\n     private DateTimeImmutable $updatedAt;\r\n \r\n     /** @var array<string, ParkingSpot> */\r\n@@ -47,91 +48,129 @@\n         int $totalCapacity,\r\n         PricingPlan $pricingPlan,\r\n         GeoLocation $location,\r\n         OpeningSchedule $openingSchedule,\r\n-        UserId $userId\r\n+        UserId $UserId,\r\n+        ?string $description = null,\r\n+        ?DateTimeImmutable $createdAt = null,\r\n+        ?DateTimeImmutable $updatedAt = null\r\n     ) {\r\n         if ($totalCapacity <= 0) {\r\n-            throw new \\InvalidArgumentException('Capacity must be greater than zero');\r\n+            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n         }\r\n \r\n         $this->id = $id;\r\n-        $this->name = $name;\r\n-        $this->address = $address;\r\n+        $this->name = trim($name);\r\n+        $this->address = trim($address);\r\n+        $this->description = $description !== null ? trim($description) : null;\r\n         $this->totalCapacity = $totalCapacity;\r\n         $this->pricingPlan = $pricingPlan;\r\n         $this->location = $location;\r\n         $this->openingSchedule = $openingSchedule;\r\n-        $this->userId = $userId;\r\n-        $this->createdAt = new DateTimeImmutable();\r\n-        $this->updatedAt = $this->createdAt;\r\n+        $this->UserId = $UserId;\r\n+        $this->createdAt = $createdAt ?? new DateTimeImmutable();\r\n+        $this->updatedAt = $updatedAt ?? $this->createdAt;\r\n     }\r\n \r\n-    /* ================= GETTERS ================= */\r\n-\r\n     public function getId(): ParkingId { return $this->id; }\r\n     public function getName(): string { return $this->name; }\r\n     public function getAddress(): string { return $this->address; }\r\n+    public function getDescription(): ?string { return $this->description; }\r\n     public function getTotalCapacity(): int { return $this->totalCapacity; }\r\n     public function getPricingPlan(): PricingPlan { return $this->pricingPlan; }\r\n     public function getLocation(): GeoLocation { return $this->location; }\r\n     public function getOpeningSchedule(): OpeningSchedule { return $this->openingSchedule; }\r\n-    public function getUserId(): UserId { return $this->userId; }\r\n+    public function getUserId(): UserId { return $this->UserId; }\r\n     public function getCreatedAt(): DateTimeImmutable { return $this->createdAt; }\r\n     public function getUpdatedAt(): DateTimeImmutable { return $this->updatedAt; }\r\n \r\n-    /* ================= SPOTS ================= */\r\n+    /** Change le plan tarifaire. */\r\n+    public function changePricingPlan(PricingPlan $newPlan): void\r\n+    {\r\n+        $this->pricingPlan = $newPlan;\r\n+        $this->touch();\r\n+    }\r\n \r\n+    /** Change les horaires d’ouverture. */\r\n+    public function changeOpeningSchedule(OpeningSchedule $schedule): void\r\n+    {\r\n+        $this->openingSchedule = $schedule;\r\n+        $this->touch();\r\n+    }\r\n+\r\n+    /* ===================== SPOTS (pour ParkingTest) ===================== */\r\n+\r\n     public function isFull(): bool\r\n     {\r\n         return count($this->parkingSpots) >= $this->totalCapacity;\r\n     }\r\n \r\n     public function addSpot(ParkingSpot $spot): void\r\n     {\r\n-        $spotId = $spot->getId()->getValue();\r\n+        $id = $spot->getId()->getValue();\r\n \r\n-        if (isset($this->parkingSpots[$spotId])) {\r\n+        if (isset($this->parkingSpots[$id])) {\r\n             throw new SpotAlreadyExistsException();\r\n         }\r\n \r\n         if ($this->isFull()) {\r\n             throw new ParkingFullException();\r\n         }\r\n \r\n-        $this->parkingSpots[$spotId] = $spot;\r\n+        $this->parkingSpots[$id] = $spot;\r\n         $this->touch();\r\n     }\r\n \r\n     public function getPhysicalFreeSpotsCount(): int\r\n     {\r\n         return $this->totalCapacity - count($this->parkingSpots);\r\n     }\r\n \r\n-    /* ================= BUSINESS ================= */\r\n+    /* ===================== ATTACH IDS ===================== */\r\n \r\n+    public function attachReservation(ReservationId $reservationId): void\r\n+    {\r\n+        $this->reservationIds[$reservationId->getValue()] = $reservationId;\r\n+    }\r\n+\r\n+    public function attachAbonnement(AbonnementId $abonnementId): void\r\n+    {\r\n+        $this->abonnementIds[$abonnementId->getValue()] = $abonnementId;\r\n+    }\r\n+\r\n+    public function attachStationnement(StationnementId $stationnementId): void\r\n+    {\r\n+        $this->stationnementIds[$stationnementId->getValue()] = $stationnementId;\r\n+    }\r\n+\r\n+    public function computeAvailability(int $activeReservations, int $activeAbonnements, int $activeStationnements): int\r\n+    {\r\n+        $used = $activeReservations + $activeAbonnements + $activeStationnements;\r\n+        return max(0, $this->totalCapacity - $used);\r\n+    }\r\n+\r\n     public function freeSpotsAt(\r\n         DateTimeImmutable $at,\r\n         iterable $reservations,\r\n         iterable $abonnements,\r\n         iterable $stationnements\r\n     ): int {\r\n         $used = 0;\r\n \r\n-        foreach ($reservations as $r) {\r\n-            if (method_exists($r, 'isActiveAt') && $r->isActiveAt($at)) {\r\n+        foreach ($reservations as $reservation) {\r\n+            if (\\method_exists($reservation, 'isActiveAt') && $reservation->isActiveAt($at)) {\r\n                 $used++;\r\n             }\r\n         }\r\n \r\n-        foreach ($abonnements as $a) {\r\n-            if (method_exists($a, 'covers') && $a->covers($at)) {\r\n+        foreach ($abonnements as $abonnement) {\r\n+            if (\\method_exists($abonnement, 'covers') && $abonnement->covers($at)) {\r\n                 $used++;\r\n             }\r\n         }\r\n \r\n-        foreach ($stationnements as $s) {\r\n-            if (method_exists($s, 'isActiveAt') && $s->isActiveAt($at)) {\r\n+        foreach ($stationnements as $stationnement) {\r\n+            if (\\method_exists($stationnement, 'isActiveAt') && $stationnement->isActiveAt($at)) {\r\n                 $used++;\r\n             }\r\n         }\r\n \r\n@@ -147,28 +186,22 @@\n     {\r\n         return $this->pricingPlan->computePriceCents($minutes);\r\n     }\r\n \r\n-    public function attachReservation(ReservationId $id): void\r\n+    public function updateCapacity(int $newCapacity): void\r\n     {\r\n-        $this->reservationIds[$id->getValue()] = $id;\r\n-    }\r\n+        if ($newCapacity <= 0) {\r\n+            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n+        }\r\n \r\n-    public function attachAbonnement(AbonnementId $id): void\r\n-    {\r\n-        $this->abonnementIds[$id->getValue()] = $id;\r\n-    }\r\n+        if ($newCapacity === $this->totalCapacity) {\r\n+            return;\r\n+        }\r\n \r\n-    public function attachStationnement(StationnementId $id): void\r\n-    {\r\n-        $this->stationnementIds[$id->getValue()] = $id;\r\n+        $this->totalCapacity = $newCapacity;\r\n+        $this->touch();\r\n     }\r\n \r\n-    public function computeAvailability(int $r, int $a, int $s): int\r\n-    {\r\n-        return max(0, $this->totalCapacity - ($r + $a + $s));\r\n-    }\r\n-\r\n     private function touch(): void\r\n     {\r\n         $this->updatedAt = new DateTimeImmutable();\r\n     }\r\n"
                },
                {
                    "date": 1766410376954,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,8 +5,9 @@\n \r\n use DateTimeImmutable;\r\n use App\\Domain\\Exception\\ParkingFullException;\r\n use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n+use App\\Domain\\Exception\\ParkingFullException;\r\n use App\\Domain\\ValueObject\\GeoLocation;\r\n use App\\Domain\\ValueObject\\OpeningSchedule;\r\n use App\\Domain\\ValueObject\\ParkingId;\r\n use App\\Domain\\ValueObject\\PricingPlan;\r\n"
                },
                {
                    "date": 1766410423336,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,10 +4,8 @@\n namespace App\\Domain\\Entity;\r\n \r\n use DateTimeImmutable;\r\n use App\\Domain\\Exception\\ParkingFullException;\r\n-use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n-use App\\Domain\\Exception\\ParkingFullException;\r\n use App\\Domain\\ValueObject\\GeoLocation;\r\n use App\\Domain\\ValueObject\\OpeningSchedule;\r\n use App\\Domain\\ValueObject\\ParkingId;\r\n use App\\Domain\\ValueObject\\PricingPlan;\r\n"
                },
                {
                    "date": 1766410586612,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -4,8 +4,9 @@\n namespace App\\Domain\\Entity;\r\n \r\n use DateTimeImmutable;\r\n use App\\Domain\\Exception\\ParkingFullException;\r\n+use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n use App\\Domain\\ValueObject\\GeoLocation;\r\n use App\\Domain\\ValueObject\\OpeningSchedule;\r\n use App\\Domain\\ValueObject\\ParkingId;\r\n use App\\Domain\\ValueObject\\PricingPlan;\r\n@@ -81,16 +82,14 @@\n     public function getUserId(): UserId { return $this->UserId; }\r\n     public function getCreatedAt(): DateTimeImmutable { return $this->createdAt; }\r\n     public function getUpdatedAt(): DateTimeImmutable { return $this->updatedAt; }\r\n \r\n-    /** Change le plan tarifaire. */\r\n     public function changePricingPlan(PricingPlan $newPlan): void\r\n     {\r\n         $this->pricingPlan = $newPlan;\r\n         $this->touch();\r\n     }\r\n \r\n-    /** Change les horaires d’ouverture. */\r\n     public function changeOpeningSchedule(OpeningSchedule $schedule): void\r\n     {\r\n         $this->openingSchedule = $schedule;\r\n         $this->touch();\r\n"
                },
                {
                    "date": 1766410836353,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,207 @@\n+<?php\r\n+declare(strict_types=1);\r\n+\r\n+namespace App\\Domain\\Entity;\r\n+\r\n+use DateTimeImmutable;\r\n+use App\\Domain\\Exception\\ParkingFullException;\r\n+use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n+use App\\Domain\\ValueObject\\GeoLocation;\r\n+use App\\Domain\\ValueObject\\OpeningSchedule;\r\n+use App\\Domain\\ValueObject\\ParkingId;\r\n+use App\\Domain\\ValueObject\\PricingPlan;\r\n+use App\\Domain\\ValueObject\\UserId;\r\n+use App\\Domain\\ValueObject\\ReservationId;\r\n+use App\\Domain\\ValueObject\\AbonnementId;\r\n+use App\\Domain\\ValueObject\\StationnementId;\r\n+\r\n+final class Parking\r\n+{\r\n+    private ParkingId $id;\r\n+    private string $name;\r\n+    private string $address;\r\n+    private ?string $description;\r\n+    private int $totalCapacity;\r\n+    private PricingPlan $pricingPlan;\r\n+    private GeoLocation $location;\r\n+    private OpeningSchedule $openingSchedule;\r\n+    private UserId $UserId; // (Owner)\r\n+    private DateTimeImmutable $createdAt;\r\n+    private DateTimeImmutable $updatedAt;\r\n+\r\n+    /** @var array<string, ParkingSpot> */\r\n+    private array $parkingSpots = [];\r\n+\r\n+    /** @var array<string, ReservationId> */\r\n+    private array $reservationIds = [];\r\n+\r\n+    /** @var array<string, AbonnementId> */\r\n+    private array $abonnementIds = [];\r\n+\r\n+    /** @var array<string, StationnementId> */\r\n+    private array $stationnementIds = [];\r\n+\r\n+    public function __construct(\r\n+        ParkingId $id,\r\n+        string $name,\r\n+        string $address,\r\n+        int $totalCapacity,\r\n+        PricingPlan $pricingPlan,\r\n+        GeoLocation $location,\r\n+        OpeningSchedule $openingSchedule,\r\n+        UserId $UserId,\r\n+        ?string $description = null,\r\n+        ?DateTimeImmutable $createdAt = null,\r\n+        ?DateTimeImmutable $updatedAt = null\r\n+    ) {\r\n+        if ($totalCapacity <= 0) {\r\n+            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n+        }\r\n+\r\n+        $this->id = $id;\r\n+        $this->name = trim($name);\r\n+        $this->address = trim($address);\r\n+        $this->description = $description !== null ? trim($description) : null;\r\n+        $this->totalCapacity = $totalCapacity;\r\n+        $this->pricingPlan = $pricingPlan;\r\n+        $this->location = $location;\r\n+        $this->openingSchedule = $openingSchedule;\r\n+        $this->UserId = $UserId;\r\n+        $this->createdAt = $createdAt ?? new DateTimeImmutable();\r\n+        $this->updatedAt = $updatedAt ?? $this->createdAt;\r\n+    }\r\n+\r\n+    public function getId(): ParkingId { return $this->id; }\r\n+    public function getName(): string { return $this->name; }\r\n+    public function getAddress(): string { return $this->address; }\r\n+    public function getDescription(): ?string { return $this->description; }\r\n+    public function getTotalCapacity(): int { return $this->totalCapacity; }\r\n+    public function getPricingPlan(): PricingPlan { return $this->pricingPlan; }\r\n+    public function getLocation(): GeoLocation { return $this->location; }\r\n+    public function getOpeningSchedule(): OpeningSchedule { return $this->openingSchedule; }\r\n+    public function getUserId(): UserId { return $this->UserId; }\r\n+    public function getCreatedAt(): DateTimeImmutable { return $this->createdAt; }\r\n+    public function getUpdatedAt(): DateTimeImmutable { return $this->updatedAt; }\r\n+\r\n+    public function changePricingPlan(PricingPlan $newPlan): void\r\n+    {\r\n+        $this->pricingPlan = $newPlan;\r\n+        $this->touch();\r\n+    }\r\n+\r\n+    public function changeOpeningSchedule(OpeningSchedule $schedule): void\r\n+    {\r\n+        $this->openingSchedule = $schedule;\r\n+        $this->touch();\r\n+    }\r\n+\r\n+    /* ===================== SPOTS (pour ParkingTest) ===================== */\r\n+\r\n+    public function isFull(): bool\r\n+    {\r\n+        return count($this->parkingSpots) >= $this->totalCapacity;\r\n+    }\r\n+\r\n+    public function addSpot(ParkingSpot $spot): void\r\n+{\r\n+    $id = $spot->getId()->getValue();\r\n+\r\n+    if (isset($this->parkingSpots[$id])) {\r\n+        throw new SpotAlreadyExistsException();\r\n+    }\r\n+\r\n+    if ($this->isFull()) {\r\n+        throw new ParkingFullException();\r\n+    }\r\n+\r\n+    $this->parkingSpots[$id] = $spot;\r\n+    $this->touch();\r\n+}\r\n+\r\n+\r\n+    public function getPhysicalFreeSpotsCount(): int\r\n+    {\r\n+        return $this->totalCapacity - count($this->parkingSpots);\r\n+    }\r\n+\r\n+    /* ===================== ATTACH IDS ===================== */\r\n+\r\n+    public function attachReservation(ReservationId $reservationId): void\r\n+    {\r\n+        $this->reservationIds[$reservationId->getValue()] = $reservationId;\r\n+    }\r\n+\r\n+    public function attachAbonnement(AbonnementId $abonnementId): void\r\n+    {\r\n+        $this->abonnementIds[$abonnementId->getValue()] = $abonnementId;\r\n+    }\r\n+\r\n+    public function attachStationnement(StationnementId $stationnementId): void\r\n+    {\r\n+        $this->stationnementIds[$stationnementId->getValue()] = $stationnementId;\r\n+    }\r\n+\r\n+    public function computeAvailability(int $activeReservations, int $activeAbonnements, int $activeStationnements): int\r\n+    {\r\n+        $used = $activeReservations + $activeAbonnements + $activeStationnements;\r\n+        return max(0, $this->totalCapacity - $used);\r\n+    }\r\n+\r\n+    public function freeSpotsAt(\r\n+        DateTimeImmutable $at,\r\n+        iterable $reservations,\r\n+        iterable $abonnements,\r\n+        iterable $stationnements\r\n+    ): int {\r\n+        $used = 0;\r\n+\r\n+        foreach ($reservations as $reservation) {\r\n+            if (\\method_exists($reservation, 'isActiveAt') && $reservation->isActiveAt($at)) {\r\n+                $used++;\r\n+            }\r\n+        }\r\n+\r\n+        foreach ($abonnements as $abonnement) {\r\n+            if (\\method_exists($abonnement, 'covers') && $abonnement->covers($at)) {\r\n+                $used++;\r\n+            }\r\n+        }\r\n+\r\n+        foreach ($stationnements as $stationnement) {\r\n+            if (\\method_exists($stationnement, 'isActiveAt') && $stationnement->isActiveAt($at)) {\r\n+                $used++;\r\n+            }\r\n+        }\r\n+\r\n+        return max(0, $this->totalCapacity - $used);\r\n+    }\r\n+\r\n+    public function isOpenAt(DateTimeImmutable $at): bool\r\n+    {\r\n+        return $this->openingSchedule->isOpenAt($at);\r\n+    }\r\n+\r\n+    public function computePriceForDurationMinutes(int $minutes): int\r\n+    {\r\n+        return $this->pricingPlan->computePriceCents($minutes);\r\n+    }\r\n+\r\n+    public function updateCapacity(int $newCapacity): void\r\n+    {\r\n+        if ($newCapacity <= 0) {\r\n+            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n+        }\r\n+\r\n+        if ($newCapacity === $this->totalCapacity) {\r\n+            return;\r\n+        }\r\n+\r\n+        $this->totalCapacity = $newCapacity;\r\n+        $this->touch();\r\n+    }\r\n+\r\n+    private function touch(): void\r\n+    {\r\n+        $this->updatedAt = new DateTimeImmutable();\r\n+    }\r\n+}\r\n"
                },
                {
                    "date": 1766411142759,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,223 +5,16 @@\n \r\n use DateTimeImmutable;\r\n use App\\Domain\\Exception\\ParkingFullException;\r\n use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n+use App\\Domain\\ValueObject\\AbonnementId;\r\n use App\\Domain\\ValueObject\\GeoLocation;\r\n use App\\Domain\\ValueObject\\OpeningSchedule;\r\n use App\\Domain\\ValueObject\\ParkingId;\r\n use App\\Domain\\ValueObject\\PricingPlan;\r\n-use App\\Domain\\ValueObject\\UserId;\r\n use App\\Domain\\ValueObject\\ReservationId;\r\n-use App\\Domain\\ValueObject\\AbonnementId;\r\n use App\\Domain\\ValueObject\\StationnementId;\r\n-\r\n-final class Parking\r\n-{\r\n-    private ParkingId $id;\r\n-    private string $name;\r\n-    private string $address;\r\n-    private ?string $description;\r\n-    private int $totalCapacity;\r\n-    private PricingPlan $pricingPlan;\r\n-    private GeoLocation $location;\r\n-    private OpeningSchedule $openingSchedule;\r\n-    private UserId $UserId; // (Owner)\r\n-    private DateTimeImmutable $createdAt;\r\n-    private DateTimeImmutable $updatedAt;\r\n-\r\n-    /** @var array<string, ParkingSpot> */\r\n-    private array $parkingSpots = [];\r\n-\r\n-    /** @var array<string, ReservationId> */\r\n-    private array $reservationIds = [];\r\n-\r\n-    /** @var array<string, AbonnementId> */\r\n-    private array $abonnementIds = [];\r\n-\r\n-    /** @var array<string, StationnementId> */\r\n-    private array $stationnementIds = [];\r\n-\r\n-    public function __construct(\r\n-        ParkingId $id,\r\n-        string $name,\r\n-        string $address,\r\n-        int $totalCapacity,\r\n-        PricingPlan $pricingPlan,\r\n-        GeoLocation $location,\r\n-        OpeningSchedule $openingSchedule,\r\n-        UserId $UserId,\r\n-        ?string $description = null,\r\n-        ?DateTimeImmutable $createdAt = null,\r\n-        ?DateTimeImmutable $updatedAt = null\r\n-    ) {\r\n-        if ($totalCapacity <= 0) {\r\n-            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n-        }\r\n-\r\n-        $this->id = $id;\r\n-        $this->name = trim($name);\r\n-        $this->address = trim($address);\r\n-        $this->description = $description !== null ? trim($description) : null;\r\n-        $this->totalCapacity = $totalCapacity;\r\n-        $this->pricingPlan = $pricingPlan;\r\n-        $this->location = $location;\r\n-        $this->openingSchedule = $openingSchedule;\r\n-        $this->UserId = $UserId;\r\n-        $this->createdAt = $createdAt ?? new DateTimeImmutable();\r\n-        $this->updatedAt = $updatedAt ?? $this->createdAt;\r\n-    }\r\n-\r\n-    public function getId(): ParkingId { return $this->id; }\r\n-    public function getName(): string { return $this->name; }\r\n-    public function getAddress(): string { return $this->address; }\r\n-    public function getDescription(): ?string { return $this->description; }\r\n-    public function getTotalCapacity(): int { return $this->totalCapacity; }\r\n-    public function getPricingPlan(): PricingPlan { return $this->pricingPlan; }\r\n-    public function getLocation(): GeoLocation { return $this->location; }\r\n-    public function getOpeningSchedule(): OpeningSchedule { return $this->openingSchedule; }\r\n-    public function getUserId(): UserId { return $this->UserId; }\r\n-    public function getCreatedAt(): DateTimeImmutable { return $this->createdAt; }\r\n-    public function getUpdatedAt(): DateTimeImmutable { return $this->updatedAt; }\r\n-\r\n-    public function changePricingPlan(PricingPlan $newPlan): void\r\n-    {\r\n-        $this->pricingPlan = $newPlan;\r\n-        $this->touch();\r\n-    }\r\n-\r\n-    public function changeOpeningSchedule(OpeningSchedule $schedule): void\r\n-    {\r\n-        $this->openingSchedule = $schedule;\r\n-        $this->touch();\r\n-    }\r\n-\r\n-    /* ===================== SPOTS (pour ParkingTest) ===================== */\r\n-\r\n-    public function isFull(): bool\r\n-    {\r\n-        return count($this->parkingSpots) >= $this->totalCapacity;\r\n-    }\r\n-\r\n-    public function addSpot(ParkingSpot $spot): void\r\n-{\r\n-    $id = $spot->getId()->getValue();\r\n-\r\n-    if (isset($this->parkingSpots[$id])) {\r\n-        throw new SpotAlreadyExistsException();\r\n-    }\r\n-\r\n-    if ($this->isFull()) {\r\n-        throw new ParkingFullException();\r\n-    }\r\n-\r\n-    $this->parkingSpots[$id] = $spot;\r\n-    $this->touch();\r\n-}\r\n-\r\n-\r\n-    public function getPhysicalFreeSpotsCount(): int\r\n-    {\r\n-        return $this->totalCapacity - count($this->parkingSpots);\r\n-    }\r\n-\r\n-    /* ===================== ATTACH IDS ===================== */\r\n-\r\n-    public function attachReservation(ReservationId $reservationId): void\r\n-    {\r\n-        $this->reservationIds[$reservationId->getValue()] = $reservationId;\r\n-    }\r\n-\r\n-    public function attachAbonnement(AbonnementId $abonnementId): void\r\n-    {\r\n-        $this->abonnementIds[$abonnementId->getValue()] = $abonnementId;\r\n-    }\r\n-\r\n-    public function attachStationnement(StationnementId $stationnementId): void\r\n-    {\r\n-        $this->stationnementIds[$stationnementId->getValue()] = $stationnementId;\r\n-    }\r\n-\r\n-    public function computeAvailability(int $activeReservations, int $activeAbonnements, int $activeStationnements): int\r\n-    {\r\n-        $used = $activeReservations + $activeAbonnements + $activeStationnements;\r\n-        return max(0, $this->totalCapacity - $used);\r\n-    }\r\n-\r\n-    public function freeSpotsAt(\r\n-        DateTimeImmutable $at,\r\n-        iterable $reservations,\r\n-        iterable $abonnements,\r\n-        iterable $stationnements\r\n-    ): int {\r\n-        $used = 0;\r\n-\r\n-        foreach ($reservations as $reservation) {\r\n-            if (\\method_exists($reservation, 'isActiveAt') && $reservation->isActiveAt($at)) {\r\n-                $used++;\r\n-            }\r\n-        }\r\n-\r\n-        foreach ($abonnements as $abonnement) {\r\n-            if (\\method_exists($abonnement, 'covers') && $abonnement->covers($at)) {\r\n-                $used++;\r\n-            }\r\n-        }\r\n-\r\n-        foreach ($stationnements as $stationnement) {\r\n-            if (\\method_exists($stationnement, 'isActiveAt') && $stationnement->isActiveAt($at)) {\r\n-                $used++;\r\n-            }\r\n-        }\r\n-\r\n-        return max(0, $this->totalCapacity - $used);\r\n-    }\r\n-\r\n-    public function isOpenAt(DateTimeImmutable $at): bool\r\n-    {\r\n-        return $this->openingSchedule->isOpenAt($at);\r\n-    }\r\n-\r\n-    public function computePriceForDurationMinutes(int $minutes): int\r\n-    {\r\n-        return $this->pricingPlan->computePriceCents($minutes);\r\n-    }\r\n-\r\n-    public function updateCapacity(int $newCapacity): void\r\n-    {\r\n-        if ($newCapacity <= 0) {\r\n-            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n-        }\r\n-\r\n-        if ($newCapacity === $this->totalCapacity) {\r\n-            return;\r\n-        }\r\n-\r\n-        $this->totalCapacity = $newCapacity;\r\n-        $this->touch();\r\n-    }\r\n-\r\n-    private function touch(): void\r\n-    {\r\n-        $this->updatedAt = new DateTimeImmutable();\r\n-    }\r\n-}\r\n-<?php\r\n-declare(strict_types=1);\r\n-\r\n-namespace App\\Domain\\Entity;\r\n-\r\n-use DateTimeImmutable;\r\n-use App\\Domain\\Exception\\ParkingFullException;\r\n-use App\\Domain\\Exception\\SpotAlreadyExistsException;\r\n-use App\\Domain\\ValueObject\\GeoLocation;\r\n-use App\\Domain\\ValueObject\\OpeningSchedule;\r\n-use App\\Domain\\ValueObject\\ParkingId;\r\n-use App\\Domain\\ValueObject\\PricingPlan;\r\n use App\\Domain\\ValueObject\\UserId;\r\n-use App\\Domain\\ValueObject\\ReservationId;\r\n-use App\\Domain\\ValueObject\\AbonnementId;\r\n-use App\\Domain\\ValueObject\\StationnementId;\r\n \r\n final class Parking\r\n {\r\n     private ParkingId $id;\r\n@@ -231,9 +24,9 @@\n     private int $totalCapacity;\r\n     private PricingPlan $pricingPlan;\r\n     private GeoLocation $location;\r\n     private OpeningSchedule $openingSchedule;\r\n-    private UserId $UserId; // (Owner)\r\n+    private UserId $userId; // owner\r\n     private DateTimeImmutable $createdAt;\r\n     private DateTimeImmutable $updatedAt;\r\n \r\n     /** @var array<string, ParkingSpot> */\r\n@@ -255,9 +48,9 @@\n         int $totalCapacity,\r\n         PricingPlan $pricingPlan,\r\n         GeoLocation $location,\r\n         OpeningSchedule $openingSchedule,\r\n-        UserId $UserId,\r\n+        UserId $userId,\r\n         ?string $description = null,\r\n         ?DateTimeImmutable $createdAt = null,\r\n         ?DateTimeImmutable $updatedAt = null\r\n     ) {\r\n@@ -272,9 +65,9 @@\n         $this->totalCapacity = $totalCapacity;\r\n         $this->pricingPlan = $pricingPlan;\r\n         $this->location = $location;\r\n         $this->openingSchedule = $openingSchedule;\r\n-        $this->UserId = $UserId;\r\n+        $this->userId = $userId;\r\n         $this->createdAt = $createdAt ?? new DateTimeImmutable();\r\n         $this->updatedAt = $updatedAt ?? $this->createdAt;\r\n     }\r\n \r\n@@ -285,9 +78,9 @@\n     public function getTotalCapacity(): int { return $this->totalCapacity; }\r\n     public function getPricingPlan(): PricingPlan { return $this->pricingPlan; }\r\n     public function getLocation(): GeoLocation { return $this->location; }\r\n     public function getOpeningSchedule(): OpeningSchedule { return $this->openingSchedule; }\r\n-    public function getUserId(): UserId { return $this->UserId; }\r\n+    public function getUserId(): UserId { return $this->userId; }\r\n     public function getCreatedAt(): DateTimeImmutable { return $this->createdAt; }\r\n     public function getUpdatedAt(): DateTimeImmutable { return $this->updatedAt; }\r\n \r\n     public function changePricingPlan(PricingPlan $newPlan): void\r\n"
                }
            ],
            "date": 1766408009798,
            "name": "Commit-0",
            "content": "<?php\r\ndeclare(strict_types=1);\r\n\r\nnamespace App\\Domain\\Entity;\r\n\r\nuse DateTimeImmutable;\r\nuse App\\Domain\\Exception\\ParkingFullException;\r\nuse App\\Domain\\Exception\\SpotAlreadyExistsException;\r\nuse App\\Domain\\ValueObject\\GeoLocation;\r\nuse App\\Domain\\ValueObject\\OpeningSchedule;\r\nuse App\\Domain\\ValueObject\\ParkingId;\r\nuse App\\Domain\\ValueObject\\PricingPlan;\r\nuse App\\Domain\\ValueObject\\UserId;\r\nuse App\\Domain\\ValueObject\\ReservationId;\r\nuse App\\Domain\\ValueObject\\AbonnementId;\r\nuse App\\Domain\\ValueObject\\StationnementId;\r\n\r\n/**\r\n * Aggregate root Parking : disponibilité, spots, règles d’accès.\r\n */\r\nfinal class Parking\r\n{\r\n    private ParkingId $id;\r\n    private string $name;\r\n    private string $address;\r\n    private ?string $description;\r\n    private int $totalCapacity;\r\n    private PricingPlan $pricingPlan;\r\n    private GeoLocation $location;\r\n    private OpeningSchedule $openingSchedule;\r\n    private UserId $UserId; // (Owner)\r\n    private DateTimeImmutable $createdAt;\r\n    private DateTimeImmutable $updatedAt;\r\n\r\n    /** @var array<string, ParkingSpot> */\r\n    private array $parkingSpots = [];\r\n\r\n    /** @var array<string, ReservationId> */\r\n    private array $reservationIds = [];\r\n\r\n    /** @var array<string, AbonnementId> */\r\n    private array $abonnementIds = [];\r\n\r\n    /** @var array<string, StationnementId> */\r\n    private array $stationnementIds = [];\r\n\r\n    public function __construct(\r\n        ParkingId $id,\r\n        string $name,\r\n        string $address,\r\n        int $totalCapacity,\r\n        PricingPlan $pricingPlan,\r\n        GeoLocation $location,\r\n        OpeningSchedule $openingSchedule,\r\n        UserId $UserId,\r\n        ?string $description = null,\r\n        ?DateTimeImmutable $createdAt = null,\r\n        ?DateTimeImmutable $updatedAt = null\r\n    ) {\r\n        if ($totalCapacity <= 0) {\r\n            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n        }\r\n\r\n        $this->id = $id;\r\n        $this->name = trim($name);\r\n        $this->address = trim($address);\r\n        $this->description = $description !== null ? trim($description) : null;\r\n        $this->totalCapacity = $totalCapacity;\r\n        $this->pricingPlan = $pricingPlan;\r\n        $this->location = $location;\r\n        $this->openingSchedule = $openingSchedule;\r\n        $this->UserId = $UserId;\r\n        $this->createdAt = $createdAt ?? new DateTimeImmutable();\r\n        $this->updatedAt = $updatedAt ?? $this->createdAt;\r\n    }\r\n\r\n    public function getId(): ParkingId { return $this->id; }\r\n    public function getName(): string { return $this->name; }\r\n    public function getAddress(): string { return $this->address; }\r\n    public function getDescription(): ?string { return $this->description; }\r\n    public function getTotalCapacity(): int { return $this->totalCapacity; }\r\n    public function getPricingPlan(): PricingPlan { return $this->pricingPlan; }\r\n    public function getLocation(): GeoLocation { return $this->location; }\r\n    public function getOpeningSchedule(): OpeningSchedule { return $this->openingSchedule; }\r\n    public function getUserId(): UserId { return $this->UserId; }\r\n    public function getCreatedAt(): DateTimeImmutable { return $this->createdAt; }\r\n    public function getUpdatedAt(): DateTimeImmutable { return $this->updatedAt; }\r\n\r\n    /** Change le plan tarifaire. */\r\n    public function changePricingPlan(PricingPlan $newPlan): void\r\n    {\r\n        $this->pricingPlan = $newPlan;\r\n        $this->touch();\r\n    }\r\n\r\n    /** Change les horaires d’ouverture. */\r\n    public function changeOpeningSchedule(OpeningSchedule $schedule): void\r\n    {\r\n        $this->openingSchedule = $schedule;\r\n        $this->touch();\r\n    }\r\n\r\n    /** ✅ AJOUT: parking complet si nb de spots == capacité */\r\n    public function isFull(): bool\r\n    {\r\n        return \\count($this->parkingSpots) >= $this->totalCapacity;\r\n    }\r\n\r\n    /** ✅ AJOUT: ajoute un spot en vérifiant doublon + capacité */\r\n    public function addSpot(ParkingSpot $spot): void\r\n    {\r\n        $spotId = $spot->getId()->getValue();\r\n\r\n        if (isset($this->parkingSpots[$spotId])) {\r\n            throw new SpotAlreadyExistsException();\r\n        }\r\n\r\n        if ($this->isFull()) {\r\n            throw new ParkingFullException();\r\n        }\r\n\r\n        $this->parkingSpots[$spotId] = $spot;\r\n        $this->touch();\r\n    }\r\n\r\n    /** ✅ AJOUT: places libres physiques restantes */\r\n    public function getPhysicalFreeSpotsCount(): int\r\n    {\r\n        return $this->totalCapacity - \\count($this->parkingSpots);\r\n    }\r\n\r\n    /** Marque une réservation liée à ce parking. */\r\n    public function attachReservation(ReservationId $reservationId): void\r\n    {\r\n        $this->reservationIds[$reservationId->getValue()] = $reservationId;\r\n    }\r\n\r\n    /** Marque un abonnement lié à ce parking. */\r\n    public function attachAbonnement(AbonnementId $abonnementId): void\r\n    {\r\n        $this->abonnementIds[$abonnementId->getValue()] = $abonnementId;\r\n    }\r\n\r\n    /** Marque un stationnement actif lié à ce parking. */\r\n    public function attachStationnement(StationnementId $stationnementId): void\r\n    {\r\n        $this->stationnementIds[$stationnementId->getValue()] = $stationnementId;\r\n    }\r\n\r\n    public function computeAvailability(int $activeReservations, int $activeAbonnements, int $activeStationnements): int\r\n    {\r\n        $used = $activeReservations + $activeAbonnements + $activeStationnements;\r\n        return max(0, $this->totalCapacity - $used);\r\n    }\r\n\r\n    /**\r\n     * Nombre de places libres à un instant t.\r\n     *\r\n     * @param iterable<int, object> $reservations   objets avec isActiveAt(DateTimeImmutable $at): bool\r\n     * @param iterable<int, object> $abonnements    objets avec covers(DateTimeImmutable $at): bool\r\n     * @param iterable<int, object> $stationnements objets avec isActiveAt(DateTimeImmutable $at): bool\r\n     */\r\n    public function freeSpotsAt(\r\n        DateTimeImmutable $at,\r\n        iterable $reservations,\r\n        iterable $abonnements,\r\n        iterable $stationnements\r\n    ): int {\r\n        $used = 0;\r\n\r\n        foreach ($reservations as $reservation) {\r\n            if (\\method_exists($reservation, 'isActiveAt') && $reservation->isActiveAt($at)) {\r\n                $used++;\r\n            }\r\n        }\r\n\r\n        foreach ($abonnements as $abonnement) {\r\n            if (\\method_exists($abonnement, 'covers') && $abonnement->covers($at)) {\r\n                $used++;\r\n            }\r\n        }\r\n\r\n        foreach ($stationnements as $stationnement) {\r\n            if (\\method_exists($stationnement, 'isActiveAt') && $stationnement->isActiveAt($at)) {\r\n                $used++;\r\n            }\r\n        }\r\n\r\n        return max(0, $this->totalCapacity - $used);\r\n    }\r\n\r\n    /** Vérifie si le parking est ouvert à un instant donné. */\r\n    public function isOpenAt(DateTimeImmutable $at): bool\r\n    {\r\n        return $this->openingSchedule->isOpenAt($at);\r\n    }\r\n\r\n    /** Calcul du prix pour une durée (en minutes) en utilisant le plan tarifaire. */\r\n    public function computePriceForDurationMinutes(int $minutes): int\r\n    {\r\n        return $this->pricingPlan->computePriceCents($minutes);\r\n    }\r\n\r\n    /** Met à jour la capacité totale. */\r\n    public function updateCapacity(int $newCapacity): void\r\n    {\r\n        if ($newCapacity <= 0) {\r\n            throw new \\InvalidArgumentException('La capacite totale doit etre superieure a zero.');\r\n        }\r\n\r\n        if ($newCapacity === $this->totalCapacity) {\r\n            return;\r\n        }\r\n\r\n        // ⚠️ règle simple: on empêche de réduire sous le nb de spots déjà existants\r\n        if ($newCapacity < \\count($this->parkingSpots)) {\r\n            throw new \\InvalidArgumentException('La nouvelle capacite ne peut pas etre inferieure au nombre de places existantes.');\r\n        }\r\n\r\n        $this->totalCapacity = $newCapacity;\r\n        $this->touch();\r\n    }\r\n\r\n    private function touch(): void\r\n    {\r\n        $this->updatedAt = new DateTimeImmutable();\r\n    }\r\n}\r\n"
        }
    ]
}